# 10x/Smart-seq2 mapping cloud

This is a collection of scripts detailing the setup and use of a cloud for analysing both 10x and Smart-seq2 data in as compatible a manner as possible. The 10x part of the deal is handled by version 2.0.2 of Cell Ranger, making use of their 1.2.0 GRCh38 reference release and a custom-built GRCh37.75 reference featuring the same `gene_biotype` categories. In turn, Smart-seq2 makes use of the 2.5.1b version of STAR shipped with Cell Ranger and the exact STAR indices that are used in both of the references, along with HTSeq for quantification.

The `setup` folder contains scripts detailing the process of creating a snapshot-ready cloud with all the necessary software and reference requirements, and then spinning off any number of worker clouds based on the created snapshots. The `scripts` folder contains both 10x and Smart-seq2 scripts used by the pipelines. The template scripts in the main directory are ready to use for both kinds of data, starting from CRAM for Smart-seq2 and CRAM or FASTQ for 10x. All you need is to plug in `RUN_LANE` combinations for Smart-seq2 or sample IDs for 10x and you're ready to go!

The 10x pipeline downloads CRAMs/FASTQs from iRODS, converts the CRAM to FASTQ if required, and calls `cellranger count`. After this is finished, it can optionally evaluate the identified cells with EmptyDrops on top of Cell Ranger's default output. The results can either be copied to the farm in full, or stored locally in a truncated version (quality report + filtered count matrix, optionally with EmptyDrops output if that was called too).

The Smart-seq2 pipeline downloads CRAMs from iRODS, along with a complete dump of the metadata for each of those files. The `sample_supplier_name` field is extracted and stored as `sampleInfo.txt` in the output. There are two count matrices created, one with CRAM file nomenclature and one with the names captured in the aforementioned file, along with a brief report on unique mapping percentages for each cell as reported by STAR. At this time, the only script template copies the results over to the farm.
